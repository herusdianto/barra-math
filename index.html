<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Barra's Math</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
    }

    :root {
      --digit-height: 70px;
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Arial', sans-serif;
      background-color: #121212;
      color: #fff;
      display: flex;
      flex-direction: column;
    }

    header {
      font-family: 'Orbitron', sans-serif;
      text-align: center;
      font-size: 32px;
      padding: 20px 0;
      color: #00ffcc;
      border-bottom: 2px solid #00ffcc;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    footer {
      text-align: center;
      padding: 10px;
      font-size: 14px;
      color: #aaa;
      border-top: 1px solid #333;
    }

    footer a {
      color: #00ffcc;
      text-decoration: none;
    }

    .line {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .digit-slot {
      width: 50px;
      height: 70px;
      border: 2px solid #444;
      overflow: hidden;
      background: #1e1e1e;
      border-radius: 6px;
      position: relative;
    }

    .digit-inner {
      position: absolute;
      top: 0;
      width: 100%;
      transition: transform 0.3s ease-in-out;
    }

    .digit-number {
      height: 70px;
      line-height: 70px;
      font-size: 40px;
      font-weight: bold;
      color: #00ffcc;
      text-align: center;
    }

    .digit-slot.no-border {
      border: none;
      background: transparent;
    }

    .underline-container {
      display: flex;
      width: fit-content;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
    }

    .underline {
      height: 4px;
      background: #00ffcc;
      flex-grow: 1;
      min-width: 50px;
    }

    .plus-symbol {
      font-size: 32px;
      color: #00ffcc;
    }

    .input-line {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .input-line input {
      width: 50px;
      height: 70px;
      font-size: 36px;
      text-align: center;
      background: #222;
      border: 2px solid #00ffcc;
      color: #fff;
      border-radius: 6px;
    }

    .timer {
      font-size: 18px;
      color: #aaa;
      margin-bottom: 10px;
    }

    #next-btn {
      display: none;
      padding: 10px 20px;
      font-size: 18px;
      background-color: #00ffcc;
      border: none;
      border-radius: 6px;
      color: #121212;
      cursor: pointer;
      user-select: none;
    }

    #next-btn:focus {
      outline: 2px solid #fff;
    }

    .history-container {
      max-width: 500px;
      margin: 0 auto;
      padding: 20px 10px;
      position: relative;
    }

    .timeline-line {
      position: absolute;
      top: 0;
      left: 30px;
      width: 4px;
      height: 100%;
      background: #00ffcc;
      opacity: 0.3;
      border-radius: 2px;
      z-index: 0;
    }

    .history-card {
      position: relative;
      background: #222;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 255, 204, 0.3);
      padding: 16px 20px;
      margin-left: 70px;
      margin-bottom: 20px;
      color: #00ffcc;
      font-size: 18px;
      font-weight: 600;
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp 0.5s forwards;
      z-index: 1;
    }

    #buttons-container {
      text-align: center;
      margin-top: 20px;
    }

    #restart-btn, #clear-history-btn {
      width: 180px;
      padding: 12px 0;
      font-size: 18px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      display: block;
      margin: 10px auto;
      user-select: none;
      box-shadow: 0 0 15px #00ffccaa;
      transition: background-color 0.3s ease;
    }

    #restart-btn {
      background-color: #00ffcc;
      color: #121212;
    }

    #restart-btn:hover {
      background-color: #00cca6;
    }

    #clear-history-btn {
      background-color: #cc3300;
      color: #fff;
      box-shadow: 0 0 15px #cc3300aa;
    }

    #clear-history-btn:hover {
      background-color: #b22a00;
    }

    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 500px) {
      :root {
        --digit-height: 60px;
      }

      .digit-slot, .input-line input {
        width: 40px;
        height: var(--digit-height);
      }

      .digit-number {
        font-size: 34px;
        height: var(--digit-height);
        line-height: var(--digit-height);
      }

      .timer {
        font-size: 16px;
      }

      #next-btn {
        font-size: 16px;
        padding: 8px 16px;
      }
    }

    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }

    input[type=number] {
      -moz-appearance: textfield;
    }
  </style>
</head>
<body>

<header>BARRA'S MATH</header>

<main>
  <div id="slot-container"></div>

  <div class="underline-container">
    <div class="underline" id="underline"></div>
    <div class="plus-symbol">+</div>
  </div>

  <div class="input-line" id="input-line" style="display: none;"></div>
  <div class="timer" id="timer" style="display: none;">00:00:000</div>

  <button id="next-btn" type="button">Next</button>
</main>

<footer>
  Built with <a href="https://chat.openai.com" target="_blank">ChatGPT</a> for Barra math practice.
</footer>

<script>
  const ROW_COUNT = 2;
  const MIN = 10;
  const MAX = 99;

  const slotContainer = document.getElementById('slot-container');
  const inputLine = document.getElementById('input-line');
  const underline = document.getElementById('underline');
  const timerEl = document.getElementById('timer');
  const nextBtn = document.getElementById('next-btn');
  const symbolEl = document.querySelector('.plus-symbol');

  let totalAnswer = 0;
  let answerDigits = [];
  let timerId = null;

  let questionCount = 0;
  let history = [];
  let currentQuestionData = null;

  function getRandomNumber(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function getRandomSubtrahend(min, max, minuend) {
    return getRandomNumber(min, Math.min(max, minuend));
  }

  function splitDigits(num) {
    return num.toString().split('').map(Number);
  }

  function createSlotDigit(finalNumber) {
    const slot = document.createElement('div');
    slot.className = 'digit-slot';

    const inner = document.createElement('div');
    inner.className = 'digit-inner';

    for (let i = 0; i < 5; i++) {
      const span = document.createElement('div');
      span.className = 'digit-number';
      span.textContent = Math.floor(Math.random() * 10);
      inner.appendChild(span);
    }

    const final = document.createElement('div');
    final.className = 'digit-number';
    final.textContent = finalNumber;
    inner.appendChild(final);

    slot.appendChild(inner);

    setTimeout(() => {
      const slotHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--digit-height'));
      inner.style.transform = `translateY(-${slotHeight * 5}px)`;
    }, 50);

    return slot;
  }

  async function showSlotRow(digits, maxLength) {
    return new Promise(resolve => {
      const line = document.createElement('div');
      line.className = 'line';

      const pad = maxLength - digits.length;
      for (let i = 0; i < pad; i++) {
        const empty = document.createElement('div');
        empty.className = 'digit-slot no-border';
        line.appendChild(empty);
      }

      digits.forEach(d => {
        line.appendChild(createSlotDigit(d));
      });

      slotContainer.appendChild(line);
      setTimeout(resolve, 1000);
    });
  }

  async function showAllRows() {
    slotContainer.innerHTML = '';
    inputLine.innerHTML = '';
    inputLine.style.display = 'none';
    nextBtn.style.display = 'none';
    timerEl.style.display = 'none';

    const isAddition = questionCount < 4;
    const operator = isAddition ? '+' : '-';
    symbolEl.textContent = operator;

    let numbers = [];
    const allDigits = [];
    let maxLen = 0;

    for (let i = 0; i < ROW_COUNT; i++) {
      let num;
      if (!isAddition && i === 1) {
        num = getRandomSubtrahend(MIN, MAX, numbers[0]);
      } else {
        num = getRandomNumber(MIN, MAX);
      }
      numbers.push(num);
      const digits = splitDigits(num);
      allDigits.push(digits);
      maxLen = Math.max(maxLen, digits.length);
    }

    const [a, b] = numbers;
    const result = isAddition ? a + b : a - b;

    totalAnswer = result;
    answerDigits = splitDigits(result);
    const totalLen = Math.max(answerDigits.length, maxLen);

    for (let digits of allDigits) {
      await showSlotRow(digits, totalLen);
    }

    underline.style.minWidth = `${totalLen * 58}px`;

    currentQuestionData = { a, b, operator, answer: result, time: null };

    showInputs(answerDigits, totalLen);
  }

  function showInputs(digits, targetLength) {
    inputLine.innerHTML = '';
    inputLine.style.display = 'flex';

    const pad = targetLength - digits.length;
    const inputs = [];

    for (let i = 0; i < pad; i++) {
      const empty = document.createElement('div');
      empty.className = 'digit-slot no-border';
      inputLine.appendChild(empty);
    }

    digits.forEach((_, i) => {
      const input = document.createElement('input');
      input.type = 'number';
      input.min = 0;
      input.max = 9;
      input.inputMode = 'numeric';
      inputLine.appendChild(input);
      inputs.push(input);
    });

    const lastIndex = inputs.length - 1;
    inputs[lastIndex].focus();

    for (let i = lastIndex; i >= 0; i--) {
      inputs[i].addEventListener('input', function () {
        const val = this.value;
        if (val === digits[i].toString()) {
          this.style.borderColor = '#0f0';

          const allCorrect = inputs.every((input, idx) => input.value === digits[idx].toString());
          if (allCorrect) {
            stopTimer();

            const finishTime = timerEl.textContent;
            currentQuestionData.time = finishTime;
            history.push(currentQuestionData);
            localStorage.setItem('mathHistory', JSON.stringify(history));

            nextBtn.style.display = 'inline-block';
            nextBtn.focus();
            inputs.forEach(input => input.disabled = true);
          } else {
            if (i === lastIndex) {
              inputs[0].focus();
            } else {
              inputs[i + 1].focus();
            }
          }
        } else if (val.length > 0) {
          this.style.borderColor = '#f00';
          const input = this;
          setTimeout(() => {
            input.value = '';
            input.style.borderColor = '#00ffcc';
            input.focus();
          }, 500);
        }
      });
    }

    startTimer();
  }

  function startTimer() {
    timerEl.style.display = 'block';
    const start = performance.now();

    function update() {
      const now = performance.now();
      const elapsed = now - start;
      const mins = String(Math.floor(elapsed / 60000)).padStart(2, '0');
      const secs = String(Math.floor((elapsed % 60000) / 1000)).padStart(2, '0');
      const ms = String(Math.floor(elapsed % 1000)).padStart(3, '0');
      timerEl.textContent = `${mins}:${secs}:${ms}`;
      timerId = requestAnimationFrame(update);
    }

    timerId = requestAnimationFrame(update);
  }

  function stopTimer() {
    if (timerId !== null) {
      cancelAnimationFrame(timerId);
      timerId = null;
    }
  }

  function showHistoryPage() {
    if (history.length === 0) {
      // Kalau kosong langsung tampil halaman soal awal
      showAllRows();
      return;
    }

    // kalau ada riwayat, tampilkan halaman riwayat
    slotContainer.innerHTML = '';
    inputLine.style.display = 'none';
    nextBtn.style.display = 'none';
    timerEl.style.display = 'none';
    underline.style.minWidth = 'auto';
    symbolEl.textContent = '';

    const historyTitle = document.createElement('h2');
    historyTitle.textContent = 'Riwayat Latihan';
    historyTitle.style.color = '#00ffcc';
    historyTitle.style.textAlign = 'center';
    historyTitle.style.marginBottom = '20px';
    slotContainer.appendChild(historyTitle);

    const container = document.createElement('div');
    container.className = 'history-container';

    // Garis timeline vertikal
    const timelineLine = document.createElement('div');
    timelineLine.className = 'timeline-line';
    container.appendChild(timelineLine);

    history.forEach((q, idx) => {
      const card = document.createElement('div');
      card.className = 'history-card';
      card.style.animationDelay = `${idx * 0.1}s`;

      const questionText = document.createElement('div');
      questionText.textContent = `${q.a} ${q.operator} ${q.b} = ${q.answer}`;
      card.appendChild(questionText);

      const timeText = document.createElement('span');
      timeText.className = 'history-time';
      timeText.textContent = `Waktu: ${q.time}`;
      card.appendChild(timeText);

      const dot = document.createElement('div');
      dot.className = 'timeline-dot';
      dot.style.top = `calc(${idx * (card.offsetHeight + 20) + 24}px)`;

      container.appendChild(card);
      container.appendChild(dot);
    });

    slotContainer.appendChild(container);

    const buttonsContainer = document.createElement('div');
    buttonsContainer.id = 'buttons-container';

    const restartBtn = document.createElement('button');
    restartBtn.id = 'restart-btn';
    restartBtn.textContent = 'Mulai Lagi';

    restartBtn.addEventListener('click', () => {
      questionCount = 0;
      showAllRows();
    });

    const clearHistoryBtn = document.createElement('button');
    clearHistoryBtn.id = 'clear-history-btn';
    clearHistoryBtn.textContent = 'Hapus Riwayat';

    clearHistoryBtn.addEventListener('click', () => {
      if (confirm('Yakin ingin menghapus semua riwayat?')) {
        history = [];
        questionCount = 0;
        localStorage.removeItem('mathHistory');
        showAllRows();  // setelah hapus riwayat langsung ke halaman soal awal
      }
    });

    buttonsContainer.appendChild(restartBtn);
    buttonsContainer.appendChild(clearHistoryBtn);

    slotContainer.appendChild(buttonsContainer);
  }

  nextBtn.addEventListener('click', () => {
    questionCount++;
    if (questionCount >= 8) {
      showHistoryPage();
    } else {
      showAllRows();
    }
  });

  showAllRows();
</script>

</body>
</html>
